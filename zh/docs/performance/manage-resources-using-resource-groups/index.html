<!doctype html>
<html lang="zh" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-performance/manage-resources-using-resource-groups" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">使用 Resource Groups 管理资源 | Apache Cloudberry (Incubating)</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://cloudberry.apache.org/zh/docs/performance/manage-resources-using-resource-groups"><meta data-rh="true" property="og:locale" content="zh"><meta data-rh="true" property="og:locale:alternate" content="en"><meta data-rh="true" name="docusaurus_locale" content="zh"><meta data-rh="true" name="docsearch:language" content="zh"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="使用 Resource Groups 管理资源 | Apache Cloudberry (Incubating)"><meta data-rh="true" name="description" content="Resource Group（资源组）可用来管理和保护 Apache Cloudberry 中 CPU、内存、并发事务限制和磁盘 I/O 的资源分配。定义资源组后，可将该组分配给一个或多个 Apache Cloudberry 用户角色（Role），或分配给外部组件（如 PL/Container），以控制其使用的资源。"><meta data-rh="true" property="og:description" content="Resource Group（资源组）可用来管理和保护 Apache Cloudberry 中 CPU、内存、并发事务限制和磁盘 I/O 的资源分配。定义资源组后，可将该组分配给一个或多个 Apache Cloudberry 用户角色（Role），或分配给外部组件（如 PL/Container），以控制其使用的资源。"><link data-rh="true" rel="icon" href="/zh/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cloudberry.apache.org/zh/docs/performance/manage-resources-using-resource-groups"><link data-rh="true" rel="alternate" href="https://cloudberry.apache.org/docs/performance/manage-resources-using-resource-groups" hreflang="en"><link data-rh="true" rel="alternate" href="https://cloudberry.apache.org/zh/docs/performance/manage-resources-using-resource-groups" hreflang="zh"><link data-rh="true" rel="alternate" href="https://cloudberry.apache.org/docs/performance/manage-resources-using-resource-groups" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/zh/blog/rss.xml" title="Apache Cloudberry (Incubating) is one advanced and mature open-source MPP (Massively Parallel Processing) databases available. RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/zh/blog/atom.xml" title="Apache Cloudberry (Incubating) is one advanced and mature open-source MPP (Massively Parallel Processing) databases available. Atom Feed">
<link rel="alternate" type="application/json" href="/zh/blog/feed.json" title="Apache Cloudberry (Incubating) is one advanced and mature open-source MPP (Massively Parallel Processing) databases available. JSON Feed">




<link rel="preconnect" href="https://analytics.apache.org/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://analytics.apache.org/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","66"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script><link rel="stylesheet" href="/zh/assets/css/styles.2da88048.css">
<script src="/zh/assets/js/runtime~main.64d6a475.js" defer="defer"></script>
<script src="/zh/assets/js/main.97c431df.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?t("light"):t("dark")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">跳到主要内容</a></div><div class="tipsWrap_WWTe"><div class="tipsContent_sMsy"><div class="text_VINd"><a href="https://github.com/apache/cloudberry" target="_blank" rel="noopener noreferrer"><span>If you like Apache Cloudberry (Incubating), give it a star on GitHub! </span><img src="/img/home/hcard/star.svg" alt=""></a></div><div class="close_vVex"><img src="/img/home/hcard/close.svg" alt=""></div></div></div><nav aria-label="主导航" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div class="nav-left-logo"><a class="navbar__brand" href="/zh/"><div class="navbar__logo"><img src="/zh/img/apache_cloudberry_color_black.svg" alt="Apache Cloudberry (Incubating)" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/zh/img/apache_cloudberry_color_white.svg" alt="Apache Cloudberry (Incubating)" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div></div><div class="navbar__items navbar__items--right"><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/zh/docs/">Docs</a><a class="navbar__item navbar__link" href="/zh/community">Community</a><a class="navbar__item navbar__link" href="/zh/contribute">Contribute</a><a class="navbar__item navbar__link" href="/zh/blog">Blog</a><a class="navbar__item navbar__link" href="/zh/docs/releases">Download</a><a class="navbar__item navbar__link" href="/zh/support">Support</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Resources</a><ul class="dropdown__menu"><li><a href="https://github.com/apache/cloudberry/discussions/369" target="_blank" rel="noopener noreferrer" class="dropdown__link">Roadmap</a></li><li><a href="https://github.com/apache/cloudberry/discussions" target="_blank" rel="noopener noreferrer" class="dropdown__link">Forum</a></li><li><a class="dropdown__link" href="/zh/bootcamp">Bootcamp</a></li><li><a class="dropdown__link" href="/zh/team">Team</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">ASF</a><ul class="dropdown__menu"><li><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Foundation</a></li><li><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="dropdown__link">License</a></li><li><a href="https://www.apache.org/events/current-event.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Events</a></li><li><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Privacy</a></li><li><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="dropdown__link">Security</a></li><li><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Sponsorship</a></li><li><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="dropdown__link">Thanks</a></li><li><a href="https://www.apache.org/foundation/policies/conduct" target="_blank" rel="noopener noreferrer" class="dropdown__link">Code of Conduct</a></li></ul></div><div class="toggle_vylO colorModeToggle_x44X check-theme-switch"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为暗黑模式）" aria-label="切换浅色/暗黑模式（当前为暗黑模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_dCNk"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="搜索" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_BF9v"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_Rg9N"><aside class="theme-doc-sidebar-container docSidebarContainer_RSuS"><div class="sidebarViewport_pYEE"><div class="sidebar_njMd"><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/">产品介绍</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/cbdb-macos-compile">部署和构建</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/zh/docs/data-loading/">加载数据</a><button aria-label="展开侧边栏分类 &#x27;加载数据&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/create-and-manage-database">创建和准备数据库</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/basic-query-syntax">操作数据</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/zh/docs/performance/">优化查询性能</a><button aria-label="折叠侧边栏分类 &#x27;优化查询性能&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/update-stats-using-analyze">更新统计信息</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/use-unique-index-on-ao-tables">在 AO 表上使用唯一索引</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/use-auto-materialized-view-to-answer-queries">自动使用物化视图进行查询优化</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/use-incremental-materialized-view">使用增量物化视图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/parallel-create-ao-refresh-mv">并行创建 AO/AOCO 表与刷新物化视图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/parallel-query-execution">并行执行查询</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/use-aggre-pushdown-to-speed-up-queries">使用聚集下推优化查询</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/use-index-scan-on-ao-tables">在 AO 表上使用 IndexScan</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/use-runtimefilter-to-optimize-queries">使用 RuntimeFilter 优化 Join 查询</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/zh/docs/performance/use-columnar-compression">使用列级压缩</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/zh/docs/performance/manage-resources-using-resource-groups">使用 Resource Groups 管理资源</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/zh/docs/security/">设置安全和权限</a><button aria-label="展开侧边栏分类 &#x27;设置安全和权限&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/sys-admin/backup-and-restore/">Manage System</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/zh/docs/sql-stmts/">参考指南</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/zh/docs/releases/">版本发布说明</a><button aria-label="展开侧边栏分类 &#x27;版本发布说明&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_hjYf"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_z5aJ"><div class="docItemContainer_c0TR"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Alpn" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/zh/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_xK9p"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><span class="breadcrumbs__link" style="cursor:pointer">优化查询性能</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">使用 Resource Groups 管理资源</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_bxCs"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>使用 Resource Groups 管理资源</h1>
<p>Resource Group（资源组）可用来管理和保护 Apache Cloudberry 中 CPU、内存、并发事务限制和磁盘 I/O 的资源分配。定义资源组后，可将该组分配给一个或多个 Apache Cloudberry 用户角色（Role），或分配给外部组件（如 PL/Container），以控制其使用的资源。</p>
<p>一个资源组所定义的限制条件适用于所有被分配该资源组的用户角色。例如，资源组定义的最大内存使用量限制会应用于所有该组用户所提交的运行事务上。</p>
<p>Apache Cloudberry 使用基于 Linux 的控制组来管理 CPU 资源，并使用 Runaway Detector 进行统计、跟踪和内存管理。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="理解角色和组件资源组">理解角色和组件资源组<a href="#理解角色和组件资源组" class="hash-link" aria-label="理解角色和组件资源组的直接链接" title="理解角色和组件资源组的直接链接">​</a></h2>
<p>Apache Cloudberry 支持两种类型的资源组：用于管理角色资源的组，及用于管理外部组件（如 PL/Container）资源的组。</p>
<p>资源组的最常见应用是管理不同角色在 Apache Cloudberry 集群中可以并发运行的活动查询数量。也可以用来管理 Apache Cloudberry 为每个查询分配的 CPU、内存资源和磁盘 I/O 的数量。</p>
<p>当用户运行查询时，Apache Cloudberry 会根据为资源组定义的一组限制评估该查询。如果该组的资源限制尚未达到，并且该查询不会导致该组超过并发事务限制，Apache Cloudberry 会立即运行该查询。如果这些条件不满足，Apache Cloudberry 会将查询进行队列排序。例如，如果资源组的最大并发事务数已经达到，后续查询将被排序等待，必须等待其他查询完成后才能运行。当资源组的并发性和内存限制调整到足够大的值时，Apache Cloudberry 也可能运行待处理的查询。</p>
<p>在角色的资源组内，事务是按照先进先出 （First-in-first-out） 原则进行评估的。Apache Cloudberry 定期评估系统的活动工作负载，根据需要重新分配资源，并启动作业或将其放入队列。</p>
<p>您还可以使用资源组来管理外部组件（如 PL/Container）的 CPU 和内存资源。外部组件的资源组使用 Linux cgroups 来管理该组件的总 CPU 资源。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="资源组属性和限制">资源组属性和限制<a href="#资源组属性和限制" class="hash-link" aria-label="资源组属性和限制的直接链接" title="资源组属性和限制的直接链接">​</a></h2>
<p>当创建资源组时，需提供一组参数，以确定该组可用的 CPU 和内存资源。下表列出了资源组的可用限制参数：</p>
<table><thead><tr><th>限制类型</th><th>描述</th><th>范围</th><th>默认值</th></tr></thead><tbody><tr><td><code>CONCURRENCY</code></td><td>资源组中允许的最大并发事务数，包括活动和空闲事务。</td><td>[0,max_connections]</td><td>20</td></tr><tr><td><code>CPU_MAX_PERCENT</code></td><td>组可使  用的 CPU 资源的最大百分比。</td><td>[1,100]</td><td>-1（未设置）</td></tr><tr><td><code>CPU_WEIGHT</code></td><td>资源组的调度优先级。</td><td>[1,500]</td><td>100</td></tr><tr><td><code>CPUSET</code></td><td>为该资源组保留的特定 CPU 逻辑核（或超线程中的逻辑线程）。</td><td>取决于系统核配置</td><td>-1</td></tr><tr><td><code>IO_LIMIT</code></td><td>读取/写入磁盘 I/O 吞吐量的最大限制，以及每秒的最大读/写 I/O 操作。按表空间设置值。</td><td>[2,4294967295 或 <code>max</code>]</td><td>-1</td></tr><tr><td><code>MEMORY_LIMIT</code></td><td>为资源组指定的内存限制值。</td><td><code>Integar</code>（MB）</td><td>-1（未设置，使用 <code>statement_mem</code> 作为单个查询的内存限制）</td></tr><tr><td><code>MIN_COST</code></td><td>查询计划被包含在资源组中的最小成本。</td><td><code>Integar</code></td><td>0</td></tr></tbody></table>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>对于 <code>SET</code> 、 <code>RESET</code> 和 <code>SHOW</code> 命令，不强制执行资源限制。</p></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="事务并发限制">事务并发限制<a href="#事务并发限制" class="hash-link" aria-label="  事务并发限制的直接链接" title="事务并发限制的直接链接">​</a></h3>
<p><code>CONCURRENCY</code> 限制控制资源组允许的最大并发事务数。</p>
<p>每个资源组在逻辑上分为与 <code>CONCURRENCY</code> 限制相等的固定数量的 slot。Apache Cloudberry 为这些 slot 分配固定百分比的内存资源。</p>
<p>角色资源组的默认 <code>CONCURRENCY</code> 限制值为 <code>20</code>。值为 <code>0</code> 表示该资源组不允许运行任何查询。</p>
<p>Apache Cloudberry 将任何在资源组达到 <code>CONCURRENCY</code> 限制后提交的事务排队。当运行的事务完成时，如果存在足够的内存资源，Apache Cloudberry 会取消排队并运行排队中最早的事务。请注意，如果事务处于 <code>idle in transaction</code> 状态，即使没有语句在运行，并发 slot 仍然处于使用中。</p>
<p>您可以设置服务器配置参数 <code>gp_resource_group_queuing_timeout</code> 来指定事务在 Apache Cloudberry 取消之前在队列中保持的时间。默认超时值为 <code>0</code>，Apache Cloudberry 会无限期地排队事务。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="绕过和解除资源组分配">绕过和解除资源组分配<a href="#绕过和解除资源组分配" class="hash-link" aria-label="绕过和解除资源组分配的直接链接" title="绕过和解除资源组分配的直接链接">​</a></h3>
<p>通过设置服务器配置参数 <code>gp_resource_group_bypass</code>，可使查询不受资源组并发设置的限制。此参数将启用或禁用资源组的并发事务限制，因此查询可以立即运行。默认值为 <code>false</code>，这将强制执行 <code>CONCURRENCY</code> 限制。此参数只可在单个会话中设置，无法在事务或函数内设置。如将 <code>gp_resource_group_bypass</code> 设置为 <code>true</code>，查询不再强制执行分配给其资源组的 CPU 或内存限制。相反，该查询分配的内存限制为每个查询的 <code>statement_mem</code>。如果没有足够的内存满足内存分配请求，查询将失败。</p>
<p>你可绕过仅 catalogue tables 的查询，例如数据库图形用户界面（GUI）客户端运行的获取元数据的 catalogue 查询。如果服务器配置参数 <code>gp_resource_group_bypass_catalog_query</code> 设置为 <code>true</code>（默认），Apache Cloudberry 的资源组调度器会绕过所有仅从系统目录读取的查询，或查询文本中仅包含 <code>pg_catalog</code> 模式表的查询。这些查询会自动解除分配其当前资源组；它们不强制执行资源组的限制，也不计算资源使用。查询资源会从资源组中分配并立即运行。内存限制为每个查询的 <code>statement_mem</code>。</p>
<p>可使用服务器配置参数 <code>gp_resource_group_bypass_direct_dispatch</code> 绕过直接调度查询。直接调度查询是一种特殊类型的查询，仅需要一个分段参与执行。为了提高效率，Apache Cloudberry 优化了此类型的查询，使用直接调度优化。系统将查询计划发送到需要执行该计划的单个分段，而不是将其发送到所有分段进行执行。如果将 <code>gp_resource_group_bypass_direct_dispatch</code> 设置为 <code>true</code>，该查询不再强制执行分配给其资源组的 CPU 或内存限制，因此立即运行。相反，该查询分配的内存限制为每个查询的 <code>statement_mem</code>。如果没有足够的内存满足内存分配请求，查询将失败。您只能在单个会话中设置此参数，而不能在事务或函数内。</p>
<p>计划成本低于限制 <code>MIN_COST</code> 的查询会自动解除分配其资源组，不强制执行其任何限制。查询使用的资源不会计算为资源组的资源。查询的内存限制为 <code>statement_mem</code>。 <code>MIN_COST</code> 的默认值为 <code>0</code>。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cpu-限制">CPU 限制<a href="#cpu-限制" class="hash-link" aria-label="CPU 限制的直接链接" title="CPU 限制的直接链接">​</a></h3>
<p>Apache Cloudberry 利用 Linux 控制组实现 CPU 资源管理。Apache Cloudberry 通过以下两种方式分配 CPU 资源：</p>
<ul>
<li>通过将 CPU 资源的百分比分配给资源组</li>
<li>通过将特定的 core 分配给资源组</li>
</ul>
<p>当为资源组设置其中一种分配模式时，Apache Cloudberry 会停用另一种分配模式。可同时为同一 Apache Cloudberry 集群的不同资源组使用两种 CPU 资源分配模式。还可以在运行时更改资源组的 CPU 资源分配模式。</p>
<p>Apache Cloudberry 使用服务器配置参数 <code>gp_resource_group_cpu_limit</code> 来识别要分配给每个 Apache Cloudberry 分段节点的资源组的最大系统 CPU 资源百分比。剩余未保留的 CPU 资源用于操作系统内核和 Apache Cloudberry 守护进程。每个主机上可用于 Apache Cloudberry 查询的 CPU 量随后平均分配给 Apache Cloudberry 节点上的每个分段。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>默认的 <code>gp_resource_group_cpu_limit</code> 值可能无法在 Apache Cloudberry 集群节点上留下足够的 CPU 资源，因此请确保相应地调整此服务器配置参数。</p></div></div>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>注意</div><div class="admonitionContent_BuS1"><p>应避免将 <code>gp_resource_group_cpu_limit</code> 设置为高于 0.9 的值。这样做可能导致高负载查询占用几乎所有 CPU 资源，导致数据库辅助进程的资源紧张。</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="按核心分配-cpu-资源">按核心分配 CPU 资源<a href="#按核心分配-cpu-资源" class="hash-link" aria-label="按核心分配 CPU 资源的直接链接" title="按核心分配 CPU 资源的直接链接">​</a></h4>
<p>可通过 <code>CPUSET</code> 属性识别要为资源组保留的 CPU 核。指定的 CPU 核必须在系统中可用，并且不能与为其他资源组保留的任何 CPU 核重叠。尽管 Apache Cloudberry 数据库将分配给资源组的核专用于该组，但这些 CPU 核也可能被系统中的非 Apache Cloudberry 进程使用。当为资源组配置 <code>CPUSET</code> 时，Apache Cloudberry 数据库会停用该组的 <code>CPU_MAX_PERCENT</code> 和 <code>CPU_WEIGHT</code>，并将它们的值设置为 -1。</p>
<p>分别为 Coordinator 和 Segment 指定 CPU 核，用分号分隔。配置 <code>CPUSET</code> 的核时，使用以逗号分隔的单核数字或数字区间。必须用单引号括起核心数字/区间，例如，‘1;1,3-4’ 在 Coordinator 上使用核 1，在分段主机上使用核 1、3 和 4。</p>
<p>当将 CPU 核心分配给 <code>CPUSET</code> 组时，请考虑以下几点：</p>
<ul>
<li>使用 <code>CPUSET</code> 创建的资源组将独占指定的核。如果组中没有正在运行的查询，则保留的核处于空闲状态，无法被其他资源组中的查询使用。考虑最小化 <code>CPUSET</code> 组的数量，以避免浪费系统 CPU 资源。</li>
<li>考虑保持 CPU 核 0 不分配。CPU 核 0 在以下情况下用作后备机制：<!-- -->
<ul>
<li><code>admin_group</code> 和 <code>default_group</code> 至少需要一个 CPU 核。当所有 CPU 核都被保留时，Apache Cloudberry 数据库将 CPU 核 0 分配给这些默认组。在这种情况下，为其分配 CPU 核 0 的资源组与 <code>admin_group</code> 和 <code>default_group</code> 共享该核。</li>
<li>如以替换节点的方式重启 Apache Cloudberry 数据库集群，并且该节点没有足够的核来服务所有 <code>CPUSET</code> 资源组，则这些组会自动分配 CPU 核 0，以避免系统启动失败。</li>
</ul>
</li>
<li>在为资源组分配核时，请使用尽可能低的核数字。如果替换 Apache Cloudberry 数据库节点，而新节点的 CPU 核少于原始节点，或者备份数据库并希望在核较少的集群中恢复，操作可能会失败。例如，如果的 Apache Cloudberry 数据库集群有 16 个核，分配核 1-7 是最佳选择。如果创建一个资源组并将 CPU 核心 9 分配给该组，则恢复到 8 核节点的数据库将失败。</li>
</ul>
<p>使用 <code>CPUSET</code> 配置的资源组在 CPU 资源上具有更高的优先级。在 Segment 主机上为所有配置了 <code>CPUSET</code> 的资源组设置的最大 CPU 资源使用百分比为保留的 CPU 核数除以所有 CPU 核数，再乘以 100。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>在为 Apache Cloudberry 数据库集群启用基于资源组的资源管理后，必须为资源组配置 <code>CPUSET</code>，该参数是 <code>gp_resource_manager</code> 服务器配置参数。</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="按百分比分配-cpu-资源">按百分比分配 CPU 资源<a href="#按百分比分配-cpu-资源" class="hash-link" aria-label="按百分比分配 CPU 资源的直接链接" title="按百分比分配 CPU 资源的直接链接">​</a></h4>
<p>通过 <code>CPU_MAX_PERCENT</code> 配置资源组，以按百分比分配 CPU 资源。当为资源组配置 <code>CPU_MAX_PERCENT</code> 时，Apache Cloudberry 数据库会停用该组的 <code>CPUSET</code>。</p>
<p>参数 <code>CPU_MAX_PERCENT</code> 设置了资源管理中段 CPU 的百分比上限。可以为资源组指定的最小 <code>CPU_MAX_PERCENT</code> 百分比为 1，最大为 100。在定义的 Apache Cloudberry 数据库集群中，所有资源组指定的 <code>CPU_MAX_PERCENT</code> 的总和可以超过 100。它指定了资源组中所有任务在给定 CPU 时间段内可以运行的总时间比例。一旦资源组中的任务使用完所有由配额指定的时间，它们将在该时间段的剩余时间内受到限制，直到下一个时间段才允许运行。</p>
<p>当资源组中的任务处于空闲状态且未使用任何 CPU 时间时，剩余时间将被收集到未使用 CPU 周期的全局池中。其他资源组可以从这个池中借用 CPU 周期。可用于资源组的实际 CPU 时间可能会有所不同，具体取决于系统中存在的资源组数量。</p>
<p>参数 <code>CPU_MAX_PERCENT</code> 强制执行 CPU 使用的硬性上限。例如，如果设置为 40%，则表示尽管资源组可以临时使用其他组的一些空闲 CPU 资源，但它最多只能使用 Apache Cloudberry 可用的 40% CPU 资源。</p>
<p>你可以设置参数 <code>CPU_WEIGHT</code> 以分配当前组的调度优先级。默认值为 100，值的范围为 1 到 500。该值指定资源组中任务可用 CPU 时间的相对份额。例如，如果一个资源组的相对份额为 100，另两个组的相对份额为 50，则当所有资源组的进程尝试使用 100% 的 CPU（即，所有组的 <code>CPU_MAX_PERCENT</code> 的值设置为 100）时，第一个资源组将获得 50% 的所有 CPU 时间，另外两个各获得 25%。然而，如果添加另一个相对份额为 100 的组，第一个组只能使用 33% 的 CPU，其余组分别获得 16.5%、16.5% 和 33%。</p>
<p>例如，考虑以下组：</p>
<table><thead><tr><th>组名称</th><th>CONCURRENCY</th><th>CPU_MAX_PERCENT</th><th>CPU_WEIGHT</th></tr></thead><tbody><tr><td>default_group</td><td>20</td><td>50</td><td>10</td></tr><tr><td>admin_group</td><td>10</td><td>70</td><td>30</td></tr><tr><td>system_group</td><td>10</td><td>30</td><td>10</td></tr><tr><td>test</td><td>10</td><td>10</td><td>10</td></tr></tbody></table>
<p>在 <code>default_group</code> 中的角色具有可用的 CPU 比率（由 <code>CPU_WEIGHT</code> 决定）为 10/(10+30+10+10)=16%。这意味着在系统工作负载较高时，它们至少可以使用 16% 的 CPU。当系统有空闲的 CPU 资源时，它们可以使用更多资源，因为硬限制（由 <code>CPU_MAX_PERCENT</code> 设置）为 50%。</p>
<p>在 <code>admin_group</code> 中的角色在系统工作负载较高时具有可用的 CPU 比率为 30/(10+30+10+10)=50%。当系统有空闲的 CPU 资源时，它们可以使用高达 70% 的硬限制的资源。</p>
<p>在 <code>test</code> 中的角色的 CPU 比率为 10/(10+30+10+10)=16%。但是，由于由 <code>CPU_MAX_PERCENT</code> 确定的硬限制为 10%  ，它们只能使用最多 10% 的资源，即使在系统空闲时也是如此。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="内存限制">内存限制<a href="#内存限制" class="hash-link" aria-label="内存限制的直接链接" title="内存限制的直接链接">​</a></h3>
<p>当启用资源组时，内存使用在 Apache Cloudberry 数据库 Segment 和资源组级别进行管理。还可以在事务级别管理内存。</p>
<p>分配给查询的内存量由以下参数确定：</p>
<p>资源组的 <code>MEMORY_LIMIT</code> 参数设置此资源组在段上的最大内存量。这决定了查询执行期间该段主机上所有工作进程可消耗的内存总量。分配给查询的内存量是组内存限制除以组并发限制： <code>MEMORY_LIMIT</code> / <code>CONCURRENCY</code>。</p>
<p>如果查询需要大量内存，您可以使用服务器配置参数 <code>gp_resgroup_memory_query_fixed_mem</code> 在会话级别为查询设置固定的内存量。该参数会覆盖并可以超出资源组的分配内存。</p>
<p>Apache Cloudberry 在处理传入查询时使用 <code>gp_resgroup_memory_query_fixed_mem</code> 的值（如果设置），以绕过资源组设置。否则，它使用 <code>MEMORY_LIMIT</code> / <code>CONCURRENCY</code> 作为查询的分配内存。如果 <code>MEMORY_LIMIT</code> 未设置，则查询内存分配的默认值为 <code>statement_mem</code>。</p>
<p>对于所有查询，如果系统内存不足，它们会溢出到磁盘。当达到限制 <code>gp_workfile_limit_files_per_query</code> 时，Apache Cloudberry 数据库会生成内存不足 (OOM) 错误。</p>
<p>例如，考虑一个名为 <code>adhoc</code> 的资源组，其 <code>MEMORY_LIMIT</code> 设置为 1.5 GB，<code>CONCURRENCY</code> 设置为 3。默认情况下，提交给该组的每个语句分配 500 MB 的内存。现在考虑以下一系列事件：</p>
<ol>
<li>
<p>用户 <code>ADHOC_1</code> 提交查询 <code>Q1</code>， 将 <code>gp_resgroup_memory_query_fixed_mem</code>   重写为 800MB。 <code>Q1</code> 语句被接纳到系统中。</p>
</li>
<li>
<p>用户 <code>ADHOC_2</code> 提交查询 <code>Q2</code>， 使用默认的 500MB。</p>
</li>
<li>
<p>在 <code>Q1</code> 和 <code>Q2</code> 仍在运行时，用户 <code>ADHOC3</code> 提交查询 <code>Q3</code>，使用默认的 500MB。</p>
<p>查询 <code>Q1</code> 和 <code>Q2</code> 已使用 1300MB 的组内 1500MB。不过，如果在该时刻段内有足够的系统内存可供查询 <code>Q3</code> 使用，可正常运行。</p>
</li>
<li>
<p>用户 <code>ADHOC4</code> 提交查询 <code>Q4</code>, 使用将 <code>gp_resgroup_memory_query_fixed_mem</code> 设置为 700MB。</p>
<p>查询 <code>Q4</code> 立即运行，因为它绕过了资源组限制。</p>
</li>
</ol>
<p>有关内存限制的一些特殊使用注意事项：</p>
<ul>
<li>如果设置配置参数 <code>gp_resource_group_bypass</code> 或 <code>gp_resource_group_bypass_catalog_query</code> 以绕过资源组限制，则查询的内存限制取 <code>statement_mem</code> 的值。</li>
<li>当 (<code>MEMORY_LIMIT</code> / <code>CONCURRENCY</code>) &lt; <code>statement_mem</code> 时，Apache Cloudberry 使用 <code>statement_mem</code> 作为分配给查询的固定内存量。</li>
<li><code>statement_mem</code> 的最大值被限制为 <code>max_statement_mem</code>。</li>
<li>计划成本低于限制 <code>MIN_COST</code> 的查询使用 <code>statement_mem</code> 的内存限制。</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="磁盘-io-限制">磁盘 I/O 限制<a href="#磁盘-io-限制" class="hash-link" aria-label="磁盘 I/O 限制的直接链接" title="磁盘 I/O 限制的直接链接">​</a></h3>
<p>Apache Cloudberry 利用 Linux 控制组实现磁盘 I/O 限制。参数 <code>IO_LIMIT</code> 限制分配给特定资源组的查询的最大读/写磁盘 I/O 吞吐量，以及最大读/写 I/O 操作数。它分配带宽，确保高优先级资源组的使用，避免过度使用磁盘带宽。该参数的值按表空间  基础设置。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>仅在使用 Linux cgroup v2 时，磁盘 I/O 限制才可用。</p></div></div>
<p>限制磁盘 I/O 时需要指定：</p>
<ul>
<li>要设置限制的表空间名称或表空间对象 ID (OID)。使用 <code>*</code> 设置所有表空间的限制。</li>
<li><code>rbps</code> 和 <code>wbps</code> 的值以限制资源组内最大读取和写入磁盘 I/O 吞吐量，单位为 MB/sec。默认值为 <code>max</code>，意味着没有限制。</li>
<li><code>riops</code> 和 <code>wiops</code> 的值以限制资源组内最大读取和写入 I/O 操作数。默认值为 <code>max</code>，意味着没有限制。</li>
</ul>
<p>如果未设置参数 <code>IO_LIMIT</code>，则 <code>rbps</code>、<code>wpbs</code>、<code>riops</code> 和 <code>wiops</code> 的默认值为 <code>max</code>，这意味着没有磁盘 I/O 限制。在这种情况下，<code>gp_toolkit.gp_resgroup_config</code> 系统视图的值显示为 <code>-1</code>。如果仅设置了 <code>IO_LIMIT</code> 的某些值（例如，<code>rbps</code>），则未设置的参数默认为 <code>max</code>（在此示例中，<code>wbps</code>、<code>riops</code> 和 <code>wiops</code>）。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置和使用资源组">配置和使用资源组<a href="#配置和使用资源组" class="hash-link" aria-label="配置和使用资源组的直接链接" title="配置和使用资源组的直接链接">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="先决条件">先决条件<a href="#先决条件" class="hash-link" aria-label="先决条件的直接链接" title="先决条件的直接链接">​</a></h3>
<p>Apache Cloudberry 资源组使用 Linux 控制组（cgroups）管理 CPU 资源和磁盘 I/O。cgroups 有两个版本： <code>cgroup v1</code> 和 <code>cgroup v2</code>。Apache Cloudberry 支持这两个版本，但仅对 cgroup v2 支持参数 <code>IO_LIMIT</code>。默认情况下随 Linux 发行版提供的 Linux 控制组版本取决于操作系统版本。对于 Enterprise Linux 8 及更早版本，默认版本为 v1；对于 Enterprise Linux 9 及更高版本，默认版本为 v2。有关 cgroups 的详细信息，请参考 Linux 发行版的控制组文档。</p>
<p>通过检查系统启动时默认挂载的文件系统，验证环境中配置的 cgroup 版本：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">stat -fc %T /sys/fs/cgroup/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>对于 cgroup v1，输出为 <code>tmpfs</code>。对于 cgroup v2，输出为 <code>cgroup2fs</code>。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>Linux 控制组可被更改，但如果你使用较旧版本的操作系统，例如 Centos 7.x 或更早，将只能使用默认的 <code>cgroup v1</code> 控制组；如果你使用的是 Centos 8.x，可按照下方步骤，将控制组从 v1 切换到 v2。</p></div></div>
<p>如无需更改 cgroup 版本，可以直接跳到 <code>optimize-performance/manage-resources-using-resource-groups:配置 cgroup v1</code> 或 <code>optimize-performance/manage-resources-using-resource-groups:配置 cgroup v2</code> 完成配置先决条件。</p>
<p>如希望从 cgroup v1 切换到 v2，可以以 root 身份运行以下命令：</p>
<ul>
<li>
<p>Red Hat 8/Rocky 8/Oracle 8 系统：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">grubby --update-kernel=/boot/vmlinuz-$(uname -r) --args=&quot;systemd.unified_cgroup_hierarchy=1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Ubuntu 系统：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim /etc/default/grub     # 添加或修改: GRUB_CMDLINE_LINUX=&quot;systemd.unified_cgroup_hierarchy=1&quot;     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">update-grub</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>如果希望从 cgroup v2 切换到 v1，可以以 root 身份运行以下命令：</p>
<ul>
<li>
<p>Red Hat 8/Rocky 8/Oracle 8 系统：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">grubby --update-kernel=/boot/vmlinuz-$(uname -r) --args=&quot;systemd.unified_cgroup_hierarchy=0 systemd.legacy_systemd_cgroup_controller&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>Ubuntu 系统：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim /etc/default/grub     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 添加或修改: GRUB_CMDLINE_LINUX=&quot;systemd.unified_cgroup_hierarchy=0&quot;     </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">update-grub</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>完成后，重启主机以使更改生效。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置-cgroup-v1">配置 cgroup v1<a href="#配置-cgroup-v1" class="hash-link" aria-label="配置 cgroup v1的直接链接" title="配置 cgroup v1的直接链接">​</a></h4>
<p>在每个 Apache Cloudberry 数据库节点上完成以下任务，以设置 cgroups v1 以用于资源组：</p>
<ol>
<li>
<p>安装 <code>libcgroup</code> 和 <code>libcgroup-tools</code>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo yum install libcgroup</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">sudo yum install libcgroup-tools</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>找到 cgroups 配置文件 <code>/etc/cgconfig.conf</code>。你必须是超级用户或具有 <code>sudo</code> 访问权限才能编辑此文件：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vi /etc/cgconfig.conf</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>将以下配置信息添加到文件中：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">group gpdb {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     perm {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         task {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">             uid = gpadmin;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">             gid = gpadmin;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         admin {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">             uid = gpadmin;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">             gid = gpadmin;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">         }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     cpu {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     cpuacct {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     cpuset {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     memory {</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">} </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>此内容配置由 <code>gpadmin</code> 用户管理的 CPU、CPU 计数、CPU 核集和内存控制组。Apache Cloudberry 数据库仅使用内存控制组监控内存使用情况。</p>
</li>
<li>
<p>在每个 Apache Cloudberry 数据库节点上启动 cgroups 服务。对于 Redhat/Oracle/Rocky 8.x 及更早版本，以 root 身份运行以下命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">cgconfigparser -l /etc/cgconfig.conf </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>为确保在系统重启时自动重建 Apache Cloudberry 数据库所需的 cgroup 层次结构和参数，配置系统 以在节点启动时启用 Linux cgroup 服务守护进程 <code>cgconfig.service</code>。为了确保配置在重启后持续有效，以 root 用户身份运行以下命令。对于 Redhat/Oracle/Rocky 8.x 及更早版本：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">systemctl enable cgconfig.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>要立即启动服务（无需重启），请输入：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">systemctl start cgconfig.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>确定节点的 <code>cgroup</code> 目录挂载点。对于 Redhat/Oracle/Rocky 8.x 及更早版本，以 root 身份运行以下命令：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">grep cgroup /proc/mounts</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>输出的第一行标识 <code>cgroup</code> 挂载点。</p>
</li>
<li>
<p>通过运行以下命令来验证您是否正确设置了 Apache Cloudberry 数据库 cgroups 配置。用前一步中识别的挂载点替换/ <code>&lt;cgroup_mount_point&gt;</code>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">ls -l &lt;cgroup_mount_point&gt;/cpu/gpdb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ls -l &lt;cgroup_mount_point&gt;/cpuset/gpdb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ls -l &lt;cgroup_mount_point&gt;/memory/gpdb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果这些目录存在并且归 <code>gpadmin:gpadmin</code> 所有，则表明已成功为 Apache Cloudberry 数据库资源管理配置了 cgroups。</p>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="配置-cgroup-v2">配置 cgroup v2<a href="#配置-cgroup-v2" class="hash-link" aria-label="配置 cgroup v2的直接链接" title="配置 cgroup v2的直接链接">​</a></h4>
<ol>
<li>
<p>配置系统以在系统启动时默认挂载 <code>cgroups-v2</code>，由 <code>systemd</code> 系统和服务管理器以 root 用户身份执行。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">grubby --update-kernel=ALL --args=&quot;systemd.unified_cgroup_hierarchy=1&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>重启系统以使更改生效:<code>reboot now</code>。</p>
</li>
<li>
<p>创建目录 <code>/sys/fs/cgroup/gpdb</code>，添加所有必要的控制器，并确保 <code>gpadmin</code> 用户具有读取和写入权限。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">mkdir -p /sys/fs/cgroup/gpdb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">echo &quot;+cpuset +io +cpu +memory&quot; | tee -a /sys/fs/cgroup/cgroup.subtree_control</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">chown -R gpadmin:gpadmin /sys/fs/cgroup/gpdb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<p>如在运行上述命令后遇到错误 <code>Invalid argument</code>，原因为 cgroups v2 不支持对实时进程的控制，并且 <code>cpu</code> 控制器只能在所有实时进程都在根 cgroup 中时启用。在这种情况下，请查找所有实时进程并将它们移动到根 cgroup 中，然后重新启用控制器。</p>
<ol>
<li>
<p>确保 <code>gpadmin</code> 对 <code>/sys/fs/cgroup/cgroup.procs</code> 具有写权限。这是为了在集群启动后将 Apache Cloudberry 进程从用户切片移动到 <code>/sys/fs/cgroup/gpdb/</code>，以管理 postmaster 服务及其所有辅助进程。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">chmod a+w /sys/fs/cgroup/cgroup.procs</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>由于资源组手动管理 cgroup 文件，以上设置在系统重启后将变得无效。为 systemd 添加以下 bash 脚本，使其在系统启动期间自动运行。作为 root 用户执行以下步骤：</p>
</li>
<li>
<p>创建 <code>gpdb.service</code>。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">vim /etc/systemd/system/gpdb.service </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>将以下内容写入 <code>gpdb.service</code>，如果用户不是 <code>gpadmin</code>，请将其替换为适当的用户。</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">[Unit]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Description=Apache Cloudberry Cgroup v2 Configuration Service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[Service]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Type=simple</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">WorkingDirectory=/sys/fs/cgroup/gpdb.service</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Delegate=yes</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">Slice=-.slice</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"># 仅在挂载 cgroup v2 时设置层次结构</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ExecCondition=bash -c &#x27;[ xcgroup2fs = x$(stat -fc &quot;%%T&quot; /sys/fs/cgroup) ] || exit 1&#x27;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ExecStartPre=bash -ec &quot; \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">chown -R gpadmin:gpadmin .; \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">chmod a+w ../cgroup.procs; \</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">mkdir -p helper.scope&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ExecStart=sleep infinity</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">ExecStartPost=bash -ec &quot;echo $MAINPID &gt; ./helper.scope/cgroup.procs;&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">[Install]</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">WantedBy=basic.target</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制 代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>重新加载 systemd 守护进程并启用服务：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">systemctl daemon-reload</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">systemctl enable gpdb.service</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="启用资源组">启用资源组<a href="#启用资源组" class="hash-link" aria-label="启用资源组的直接链接" title="启用资源组的直接链接">​</a></h2>
<p>当安装 Apache Cloudberry 时，默认情况下未启用任何资源管理策略。要使用资源组，请设置 <code>gp_resource_manager</code> 服务器配置参数。</p>
<ol>
<li>
<p>将 <code>gp_resource_manager</code> 服务器配置参数设置为值 <code>&quot;group&quot;</code> 或 <code>&quot;group-v2&quot;</code> ，具体取决于您 Linux 发行版上配置的 cgroup 版本。例如：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">gpconfig -c gp_resource_manager -v &quot;group&quot;</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">gpconfig -c gp_resource_manager -v &quot;group-v2&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>重启 Apache Cloudberry：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">gpstop</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain">gpstart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<p>启用后，由角色提交的任何事务将被指向分配给该角色的资源组，并受到该资源组的并发、内存、CPU 和磁盘 I/O 限制的管理。</p>
<p>Apache Cloudberry 为名为 <code>admin_group</code>、/ <code>default_group</code> 和 <code>system_group</code> 的角色创建三个默认资源组。当启用资源组时，任何未明确分配资源组的角色将被分配为角色能力的默认组。/ <code>SUPERUSER</code> 角色被分配到 <code>admin_group</code>，非管理员角色被分配到名为 <code>default_group</code> 的组。Apache Cloudberry 系统进程的资源被分配到 <code>system_group</code>。您不能手动将任何角色分配给 <code>system_group</code>。</p>
<p>可使用以下命令，查看包括默认资源组 <code>admin_group</code>、/ <code>default_group</code> 和 <code>system_group</code> 在内的所有资源组参数：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> gp_toolkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">gp_resgroup_config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="创建资源组">创建资源组<a href="#创建资源组" class="hash-link" aria-label="创建资源组的直接链接" title="创建资源组的直接链接">​</a></h2>
<p>当为角色创建资源组时，需要提供名称和 CPU 资源分配模式（核或百分比）。还可以选择性地提供并发事务限制、内存限制、CPU 软优先级、磁盘 I/O 限制和最低成本。使用 <code>CREATE RESOURCE GROUP</code> 命令创建新的资源组。</p>
<p>为角色创建资源组时，必须提供 <code>CPU_MAX_PERCENT</code> 或 <code>CPUSET</code> 限制值。这些限制确定分配给该资源组的 Apache Cloudberry CPU 资源的百分比。可指定 <code>MEMORY_LIMIT</code> 来为资源组保留固定数量的内存。</p>
<p>例如，要创建一个名为 <em>rgroup1</em> 的资源组，其 CPU 限制为 20，内存限制为 25，CPU 软优先级为 500，最低成 本为 50，以及 <code>pg_default</code> 表空间的磁盘 I/O 限制：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> RESOURCE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> rgroup1 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WITH</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain">CONCURRENCY</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> CPU_MAX_PERCENT</span><span class="token operator">=</span><span class="token number">20</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> MEMORY_LIMIT</span><span class="token operator">=</span><span class="token number">250</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> CPU_WEIGHT</span><span class="token operator">=</span><span class="token number">500</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> MIN_COST</span><span class="token operator">=</span><span class="token number">50</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> IO_LIMIT</span><span class="token operator">=</span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;pg_default: wbps=1000, rbps=1000, wiops=100, riops=100&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>使用 <code>cgroup v1</code> 并指定了 IO_LIMIT，仍可创建资源组。但会提示 IO_LIMIT 仅支持 v2 资源组。</p><p>CPU 限制 20 被分配给每个分配到 <code>rgroup1</code> 的角色。同样，内存限制 25 也被分配给每个分配到 <code>rgroup1</code> 的角色。/ <code>rgroup1</code> 使用默认的 <code>CONCURRENCY</code> 设置 20。</p></div></div>
<p><code>ALTER RESOURCE GROUP</code> 命令用于更新资  源组的限制。要更改资源组的限制，请指定您想要的新值。例如：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ALTER</span><span class="token plain"> RESOURCE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> rg_role_light </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> CONCURRENCY </span><span class="token number">7</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ALTER</span><span class="token plain"> RESOURCE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">exec</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> MEMORY_LIMIT </span><span class="token number">30</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ALTER</span><span class="token plain"> RESOURCE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> rgroup1 </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> CPUSET </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;1;2,4&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ALTER</span><span class="token plain"> RESOURCE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> sales </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SET</span><span class="token plain"> IO_LIMIT </span><span class="token string" style="color:rgb(255, 121, 198)">&#x27;tablespace1:wbps=2000,wiops=2000;tablespace2:rbps=2024,riops=2024&#x27;</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>不能将 <code>admin_group</code> 的 <code>CONCURRENCY</code> 值设置或更改为零 (0)。</p></div></div>
<p><code>DROP RESOURCE GROUP</code> 命令用于删除资源组。要删除某个角色的资源组，该组不能分配给任何角色，且不能有任何正在活动或等待的事务。</p>
<p>删除资源组：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">DROP</span><span class="token plain"> RESOURCE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">exec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="配置基于内存用量的自动查询终结">配置基于内存用量的自动查询终结<a href="#配置基于内存用量的自动查询终结" class="hash-link" aria-label="配置基于内存用量的自动查询终结的直接链接" title="配置基于内存用量的自动查询终结的直接链接">​</a></h2>
<p>Apache Cloudberry 支持 Runaway 检测器，它根据查询使用的内存量自动终止查询。对于资源组管理的查询，Apache Cloudberry 根据查询使用的内存量终止正在运行的查询。相关的配置参数有：</p>
<ul>
<li><code>gp_vmem_protect_limit</code> 设置活动段实例中所有 <code>postgres</code> 进程可以消耗的内存量。如果查询导致超过此限制，则不会分配内存，查询将失败。</li>
<li><code>runaway_detector_activation_percent</code> 当启用资源组时，如果使用的内存超过指定值 <code>gp_vmem_protect_limit</code> * <code>runaway_detector_activation_percent</code>，Apache Cloudberry 将根据内存使用情况终止查询，从用户资源组管理的查询中选择查询（不包括 <code>system_group</code> 资源组中的查询）。Apache Cloudberry 将首先处理消耗内存最多的查询。查询将持续终止，直到使用的内存百分比降到指定百分比以下。</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="将资源组分配给用户角色">将资源组分配给用户角色<a href="#将资源组分配给用户角色" class="hash-link" aria-label="将资源组分配给用户角色的直接链接" title="将资源组分配给用户角色的直接链接">​</a></h2>
<p>可使用 <code>CREATE ROLE</code> 或 <code>ALTER ROLE</code> 命令的 <code>RESOURCE GROUP</code> 子句将资源组分配给数 据库角色。如果不为角色指定资源组，则该角色将被分配为角色能力的默认组。<code>SUPERUSER</code> 角色被分配到 <code>admin_group</code>，非管理员角色被分配到名为 <code>default_group</code> 的组。</p>
<p>使用 <code>ALTER ROLE</code> 或 <code>CREATE ROLE</code> 命令将资源组分配给角色。例如：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ALTER</span><span class="token plain"> ROLE bill RESOURCE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> rg_light</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">CREATE</span><span class="token plain"> ROLE mary RESOURCE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">exec</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可以将资源组分配给一个或多个角色。如果定义了角色层次结构，将资源组分配给父角色不会传播到该角色组的成员。</p>
<p>如希望从角色中移除资源组分配并将角色分配为默认组，请将角色的组名称分配更改为 <code>NONE</code>。例如：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">ALTER</span><span class="token plain"> ROLE mary RESOURCE </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">GROUP</span><span class="token plain"> NONE</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="监控资源组状态">监控资源组状态<a href="#监控资源组状态" class="hash-link" aria-label="监控资源组状态的直接链接" title="监控资源组状态的直接链接">​</a></h2>
<p>监视资源组和查询的状态可能涉及以下任务。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="浏览资源组限制">浏览资源组限制<a href="#浏览资源组限制" class="hash-link" aria-label="浏览资源组限制的直接链接" title="浏览资源组限制的直接链接">​</a></h3>
<p><code>gp_resgroup_config</code>. <code>gp_toolkit</code> 系统视图显示资源组的当前限制。要查看所有资源组的限制：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> gp_toolkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">gp_resgroup_config</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="浏览资源组查询状态">浏览资源组查询状态<a href="#浏览资源组查询状态" class="hash-link" aria-label="浏览资源组查询状态的直接链接" title="浏览资源组查询状态的直接链接">​</a></h3>
<p><code>gp_resgroup_status</code>.<code>gp_toolkit</code> 系统视图能够查看资源组的状态和活动。该视图显示正在运行和排队的事务数量。要查看此信息：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> gp_toolkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">gp_resgroup_status</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="按主机浏览资源组内存使用">按主机浏览资源组内存使用<a href="#按主机浏览资源组内存使用" class="hash-link" aria-label="按主机浏览资源组内存使用的直接链接" title="按主机浏览资源组内存使用的直接链接">​</a></h3>
<p><code>gp_resgroup_status_per_host</code> <code>gp_toolkit</code> 系统视图能按主机查看资源组的实时内存使用情况。要查看此信息：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> gp_toolkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">gp_resgroup_status_per_host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="浏览用户角色被分配的资源组">浏览用户角色被分配的资源组<a href="#浏览用户角色被分配的资源组" class="hash-link" aria-label="浏览用户角色被分配的资源组的直接链接" title="浏览用户角色被分配的资源组的直接链接">​</a></h3>
<p>要查看资源组与角色的分配关系，请在 <code>pg_roles</code> 和 <code>pg_resgroup</code> 系统目录表上执行以下查询：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> rolname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> rsgname </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> pg_roles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> pg_resgroup</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> pg_roles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rolresgroup</span><span class="token operator">=</span><span class="token plain">pg_resgroup</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">oid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="浏览资源组磁盘-io-使用情况">浏览资源组磁盘 I/O 使用情况<a href="#浏览资源组磁盘-io-使用情况" class="hash-link" aria-label="浏览资源组磁盘 I/O 使用情况的直接链接" title="浏览资源组磁盘 I/O 使用情况的直接链接">​</a></h3>
<p><code>gp_resgroup_iostats_per_host</code> <code>gp_toolkit</code> 系统视图能按主机查看资源组的实时磁盘 I/O 使用情况。要查看此信息：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> gp_toolkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">gp_resgroup_iostats_per_host</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="浏览资源组运行中和等待中的查询">浏览资源组运行中和等待中的查询<a href="#浏览资源组运行中和等待中的查询" class="hash-link" aria-label="浏览资源组运行中和等待中的查询的直接链接" title="浏览资源组运行中和等待中的查询的直接链接">​</a></h3>
<p>要查看资源组的运行查询、待处理查询及其排队时间，请检查 <code>pg_stat_activity</code> 系统目录表：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> query</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> rsgname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> wait_event_type</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> wait_event </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> pg_stat_activity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>pg_stat_activity</code> 显示关于发起查询的用户/角色的信息。使用外部组件（如 PL/Container）的查询由两个部分组成：在 Apache Cloudberry 中运行的查询操作符和在 PL/Container 实例中运行的 UDF。Apache Cloudberry 在分配给发起查询的角色的资源组下处理查询操作符。运行在 PL/Container 实例中的 UDF 在分配给 PL/Container 运行时的资源组下运行。后者不在 <code>pg_stat_activity</code> 视图中表示；Apache Cloudberry 对外部组件（如 PL/Container）在运行实例中如何管理内存没有任何洞察。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="取消资源组中正在运行或在队列中的查询">取消资源组中正在运行或在队列中的查询<a href="#取消资源组中正在运行或在队列中的查询" class="hash-link" aria-label="取消资源组中正在运行或在队列中的查询的直接链接" title="取消资源组中正在运行或在队列中的查询的直接链接">​</a></h3>
<p>取消资源组中正在运行或排队的事务，例如，移除一个在资源组队列中等待但尚未运行的查询。或者，停止一个运行时间过长的查询，或一个在事务中处于空闲状态并占用其他用户所需的资源组事务槽的查询。</p>
<p>默认情况下，事务可以在资源  组中无限期排队。如希望 Apache Cloudberry 在特定时间后取消排队事务，请设置服务器配置参数 <code>gp_resource_group_queuing_timeout</code>。当此参数设置为大于 0 的值（毫秒）时，Apache Cloudberry 会在排队事务等待超过配置超时后取消该事务。</p>
<p>要手动取消正在运行或排队的事务，须首先确定与该事务关联的进程 ID（pid）。获取进程 ID 后，可以调用 <code>pg_cancel_backend()</code> 来结束该进程，如下所示。</p>
<p>例如，要查看与当前在所有资源组中活动或等待的所有语句相关的进程信息，请运行以下查询。如果查询没有返回结果，则表示在任何资源组中没有正在运行或排队的事务。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> rolname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> g</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rsgname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> pid</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> waiting</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> state</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> query</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> datname </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> pg_roles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> gp_toolkit</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">gp_resgroup_status g</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> pg_stat_activity </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">WHERE</span><span class="token plain"> pg_roles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rolresgroup</span><span class="token operator">=</span><span class="token plain">g</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">groupid</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token operator">AND</span><span class="token plain"> pg_stat_activity</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">usename</span><span class="token operator">=</span><span class="token plain">pg_roles</span><span class="token punctuation" style="color:rgb(248, 248, 242)">.</span><span class="token plain">rolname</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>示例部分查询输出：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">rolname </span><span class="token operator">|</span><span class="token plain"> rsgname  </span><span class="token operator">|</span><span class="token plain"> pid     </span><span class="token operator">|</span><span class="token plain"> waiting </span><span class="token operator">|</span><span class="token plain"> state  </span><span class="token operator">|</span><span class="token plain">          query           </span><span class="token operator">|</span><span class="token plain"> datname </span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"></span><span class="token comment" style="color:rgb(98, 114, 164)">---------+----------+---------+---------+--------+------------------------ -+---------</span><span class="token plain"></span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> sammy  </span><span class="token operator">|</span><span class="token plain"> rg_light </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">31861</span><span class="token plain">  </span><span class="token operator">|</span><span class="token plain">    f    </span><span class="token operator">|</span><span class="token plain"> idle   </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> mytesttbl</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain"> </span><span class="token operator">|</span><span class="token plain"> testdb</span><br></span><span class="token-line" style="color:#F8F8F2"><span class="token plain"> billy  </span><span class="token operator">|</span><span class="token plain"> rg_light </span><span class="token operator">|</span><span class="token plain">  </span><span class="token number">31905</span><span class="token plain">  </span><span class="token operator">|</span><span class="token plain">    t    </span><span class="token operator">|</span><span class="token plain"> active </span><span class="token operator">|</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">FROM</span><span class="token plain"> topten</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><span class="token plain">    </span><span class="token operator">|</span><span class="token plain"> testdb</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用此输出识别要取消的事务进程 ID（<code>pid</code>），然后取消该进程。例如，要取消上述示例输出中识别的待处理查询：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">SELECT</span><span class="token plain"> pg_cancel_backend</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token number">31905</span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可在 <code>pg_cancel_backend()</code> 的第二个参数中提供可选消息，以向用户指示为何取消该进程。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>请勿使用操作系统的 <code>KILL</code> 命令来取消任何 Apache Cloudberry 进程。</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="将查询移动至另一资源组">将查询移动至另一资源组<a href="#将查询移动至另一资源组" class="hash-link" aria-label="将查询移动至另一资源组的直接链接" title="将查询移动至另一资源组的直接链接">​</a></h2>
<p>具有 Apache Cloudberry 超级用户权限的用户可以运行 <code>gp_toolkit.pg_resgroup_move_query()</code> 函数，将正在运行的查询从一个资源组移动到另一个资源组，而无需停止查询。使用此函数可以通过将查询移动到资源分配或可用性更高的资源组来加速长时间运行的查询。</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>备注</div><div class="admonitionContent_BuS1"><p>只能将活动或正在运行的查询移动到新的资源组。不能移动由于并发或内存限制而处于空闲状态的排队或待处理查询。</p></div></div>
<p><code>pg_resgroup_move_query()</code> 需要正在运行查询的进程 ID（pid），以及您要将查询移动到的资源组的名称。该函数的签名如下：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#F8F8F2;--prism-background-color:#282A36"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#F8F8F2;background-color:#282A36"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#F8F8F2"><span class="token plain">pg_resgroup_move_query</span><span class="token punctuation" style="color:rgb(248, 248, 242)">(</span><span class="token plain"> pid int4</span><span class="token punctuation" style="color:rgb(248, 248, 242)">,</span><span class="token plain"> group_name </span><span class="token keyword" style="color:rgb(189, 147, 249);font-style:italic">text</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(248, 248, 242)">)</span><span class="token punctuation" style="color:rgb(248, 248, 242)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>可从 <code>pg_stat_activity</code> 系统视图获取正  在运行的查询的 pid，如 <code>optimize-performance/manage-resources-using-resource-groups:取消资源组中正在运行或在队列中的查询</code> 中所述。使用 <code>gp_toolkit.gp_resgroup_status</code> 视图列出每个资源组的名称、ID 和状态。</p>
<p>调用 <code>pg_resgroup_move_query()</code> 时，查询将受到目标资源组配置的限制：</p>
<ul>
<li>如该组已经达到并发任务限制，Apache Cloudberry 会将查询排队，直到有插槽打开或达到 <code>gp_resource_group_queuing_timeout</code> 毫秒（如设置）。</li>
<li>如该组有空闲插槽，<code>pg_resgroup_move_query()</code> 将尝试将插槽控制权交给目标进程，最长时间为 <code>gp_resource_group_move_timeout</code> 毫秒。如果目标进程无法处理移动请求直到 <code>gp_resource_group_queuing_timeout</code> 超过，Apache Cloudberry 将返回错误：“<code>target process failed to move to a new group</code>”。</li>
<li>如 <code>pg_resgroup_move_query()</code> 被取消，但目标进程已经获得了所有插槽控制权，则段的进程将不会被移动到新组，目标进程将保持插槽。这种不一致状态将通过事务结束或目标进程在同一事务内部调度的任何下一个命令来修复。</li>
<li>如目标资源组没有足够的内存来满足查询当前的内存要求，Apache Cloudberry 将返回错误：“/ <code>group &lt;group_name&gt; doesn&#x27;t have enough memory ...</code>”。在这种情况下，您可以选择增加分配给目标资源组的共享内存，或等待一段时间让正在运行的查询完成，然后再次调用该函数。</li>
</ul>
<p>在 Apache Cloudberry 移动查询后，无法保证当前在目标资源组中运行的查询不会超过组的内存限制。在这种情况下，目标组中的一个或多个正在运行的查询可能会失败，包括被移动的查询。请保留足够的资源组全局共享内存，以最小化这种情况发生的可能性。</p>
<p><code>pg_resgroup_move_query()</code> 仅将指定的查询移动到目标资源组。Apache Cloudberry 会将在会话中提交的后续查询分配到原始资源组。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="常见问题解答">常见问题解答<a href="#常见问题解答" class="hash-link" aria-label="常见问题解答的直接链接" title="常见问题解答的直接链接">​</a></h2>
<p><strong>为什么 CPU 使用率低于为资源组配置的 CPU_MAX_PERCENT 值？</strong></p>
<p>当资源组中运行的查询和切片数量较少，并且这些进程没有利用系统上的所有核心时，可能会遇到这种情况。</p>
<p><strong>我的资源组有相当于 40% 的 CPU_WEIGHT。为什么 CPU 使用率从未达到这个限制？</strong></p>
<p><code>CPU_MAX_PERCENT</code> 的值可能低于 40。因此即使有空闲资源，也可能限制 CPU 使用。</p>
<p><strong>为什么正在运行的事务数量低于为资源组配置的 CONCURRENCY 限制？</strong></p>
<p>Apache Cloudberry 在运行事务之前会考虑内存可用性，如果没有足够的内存可供服务，则会将事务排队。如使用 <code>ALTER RESOURCE GROUP</code> 增加资源组的 <code>CONCURRENCY</code> 限制，但没有同时调整内存限制，当前正在运行的事务可能会消耗掉该组的所有分配内存资源。在这种状态下，Apache Cloudberry 会将后续事务排队在资源组中。</p>
<p><strong>为什么资源组中的正在运行事务数量高于配置的 <code>CONCURRENCY</code> 限制？</strong></p>
<p>这种行为是预期的。可能出现这种情况的原因有几个：</p>
<ul>
<li>资源组不会对 <code>SET</code>、/ <code>RESET</code> 和 <code>SHOW</code> 命令执行资源限制。</li>
<li>服务器配置参数 <code>gp_resource_group_bypass</code> 禁用资源组的并发事务限制，因此查询可以立即运行。</li>
<li>如果服务器配置参数 <code>gp_resource_group_bypass_catalog_query</code> 设置为/ <code>true</code>（默认值），则所有仅从  系统目录读取的查询，或查询文本中仅包含 <code>pg_catalog</code> 模式表的查询将不执行资源组的限制。</li>
<li>计划成本低于限制 <code>MIN_COST</code> 的查询将自动从其资源组中取消分配，并不会执行设置的任何限制。</li>
</ul>
<p><strong>为什么我的查询返回了“内存限制已达到”的错误？</strong></p>
<p>当使用 <code>ALTER RESOURCE GROUP</code> 更改资源组的内存和/或并发限制时，Apache Cloudberry 会自动调整事务和组内存到新设置。如最近更改了资源组属性，并且当前运行的查询没有足够的可用内存，则可能会出现“内存不足”错误。</p>
<p><strong>我的查询由于内存不足而无法运行，导致内存泄漏（OOM）。</strong></p>
<p>首先，确保资源组分配的内存足够满足查询的需求，通过调整资源组参数，如 <code>CONCURRENCY</code> 和 <code>MEMORY_LIMIT</code>。分析查询的类型，是否会产生大量的中间结果占用内存。如果确实存在，可设置合理的 <code>gp_resgroup_memory_query_fixed_mem</code>，以便在会话级别为该特定查询分配更多内存。</p>
<p><strong>在内存泄漏（OOM）后，系统的并发负载很高。</strong></p>
<p>当系统开始清理因内存泄漏而留下的会话时，此时系统的并发负载很高，OOM 错误消息可能会再次出现。由于当前设计，我们无法加快流浪会话的清理过程。解决此问题的方案是将 <code>runaway_detector_activation_percent</code> 调整为 0.85 或 0.8，甚至更低，以增加段主机的可用内存。</p>
<p><strong>某些事务请求仅在特定时间段内运行，其他时间不运行。</strong></p>
<p>可以动态更改资源组的配置，以定期匹配工作负载的需求，并在不同时间自定义资源分配，以实现更高的效率。例如，更改组内的资源配置，添加或删除资源组。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/apache/cloudberry-site/edit/main/i18n/zh/docusaurus-plugin-content-docs/current/performance/manage-resources-using-resource-groups.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_VsjB"><span class="theme-last-updated">最后<!-- -->由 <b>zhangfei</b> <!-- -->于 <b><time datetime="2025-02-05T02:02:01.000Z">2025年2月5日</time></b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文件选项卡"><a class="pagination-nav__link pagination-nav__link--prev" href="/zh/docs/performance/use-columnar-compression"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label single-line-overflow hide-before-after">使用列级压缩</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/zh/docs/security/"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label single-line-overflow hide-before-after">Security and Permission</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_jeP5 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#理解角色和组件资源组" class="table-of-contents__link toc-highlight">理解角色和组件资源组</a></li><li><a href="#资源组属性和限制" class="table-of-contents__link toc-highlight">资源组属性和限制</a></li><li><a href="#配置和使用资源组" class="table-of-contents__link toc-highlight">配置和使用资源组</a></li><li><a href="#启用资源组" class="table-of-contents__link toc-highlight">启用资源组</a></li><li><a href="#创建资源组" class="table-of-contents__link toc-highlight">创建资源组</a></li><li><a href="#配置基于内存用量的自动查询终结" class="table-of-contents__link toc-highlight">配置基于内存用量的自动查询终结</a></li><li><a href="#将资源组分配给用户角色" class="table-of-contents__link toc-highlight">将资源组分配给用户角色</a></li><li><a href="#监控资源组状态" class="table-of-contents__link toc-highlight">监控资源组状态</a></li><li><a href="#将查询移动至另一资源组" class="table-of-contents__link toc-highlight">将查询移动至另一资源组</a></li><li><a href="#常见问题解答" class="table-of-contents__link toc-highlight">常见问题解答</a></li></ul></div></div></div></div></main></div></div></div><div class="wrap_QlFE"><div class="mainWrap_IbWk"><div class="linksWrap_Zcc4"><div><div class="footerLinkTitle_PxTg">Support</div><div class="footerLinkItem_Kf4k"><a href="https://github.com/apache/cloudberry/issues" target="_blank" rel="noopener noreferrer">GitHub Issues</a></div><div class="footerLinkItem_Kf4k"><a href="https://github.com/apache/cloudberry/discussions" target="_blank" rel="noopener noreferrer">GitHub Discussions</a></div><div class="footerLinkItem_Kf4k"><a href="https://inviter.co/apache-cloudberry" target="_blank" rel="noopener noreferrer">Slack</a></div><div class="footerLinkItem_Kf4k"><a href="https://x.com/ASFCloudberry" target="_blank" rel="noopener noreferrer">Twitter</a></div><div class="footerLinkItem_Kf4k"><a href="https://youtube.com/@ApacheCloudberry" target="_blank" rel="noopener noreferrer">Youtube</a></div><div class="footerLinkItem_Kf4k"><a target="_self" href="/zh/community/security">Security</a></div></div><div><div class="footerLinkTitle_PxTg">Resources</div><div class="footerLinkItem_Kf4k"><a href="https://github.com/apache/cloudberry/releases" target="_blank" rel="noopener noreferrer">Download</a></div><div class="footerLinkItem_Kf4k"><a target="_self" href="/zh/docs/">Documentation</a></div><div class="footerLinkItem_Kf4k"><a target="_self" href="/zh/community/events">Events</a></div><div class="footerLinkItem_Kf4k"><a href="/zh/community/brand" target="_blank">Brand Guidelines</a></div></div><div><div class="footerLinkTitle_PxTg">Contribution</div><div class="footerLinkItem_Kf4k"><a target="_self" href="/zh/contribute/git">Working with Git &amp; GitHub</a></div><div class="footerLinkItem_Kf4k"><a target="_self" href="/zh/contribute/how-to-contribute">Contribution Overview</a></div><div class="footerLinkItem_Kf4k"><a target="_self" href="/zh/contribute/code">Code Contribution</a></div><div class="footerLinkItem_Kf4k"><a target="_self" href="/zh/contribute/doc">Doc Contribution</a></div></div></div><div class="logoLinkWrap_MDp5"><div class="logoWrap_qcVI"><img class="logo_cphB" src="/zh/img/apache-incubator.svg" alt=""></div><div class="links_yA93"><svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" class="item_KKoc" cursor="pointer"><path d="M15.002 0c-8.288 0-15 6.713-15 15 0 6.637 4.293 12.244 10.256 14.231.75.131 1.031-.319 1.031-.712 0-.356-.019-1.538-.019-2.794-3.769.694-4.744-.919-5.044-1.763-.168-.43-.9-1.762-1.537-2.118-.525-.282-1.275-.975-.019-.994 1.181-.019 2.025 1.087 2.306 1.537 1.35 2.27 3.507 1.632 4.37 1.238.13-.975.524-1.631.956-2.006-3.338-.375-6.826-1.669-6.826-7.406 0-1.632.582-2.982 1.538-4.032-.15-.375-.675-1.912.15-3.975 0 0 1.256-.394 4.125 1.538 1.2-.338 2.475-.506 3.75-.506s2.55.168 3.75.506c2.869-1.95 4.125-1.538 4.125-1.538.825 2.063.3 3.6.15 3.975.956 1.05 1.538 2.382 1.538 4.032 0 5.756-3.507 7.03-6.844 7.406.544.468 1.012 1.369 1.012 2.775 0 2.006-.018 3.619-.018 4.125 0 .394.28.862 1.03.712A15.024 15.024 0 0 0 30.003 15c0-8.287-6.713-15-15-15Z"></path></svg><svg width="32" height="26" viewBox="0 0 32 26" fill="none" xmlns="http://www.w3.org/2000/svg" class="item_KKoc" cursor="pointer"><path d="M31.319 3.484c-1.145.507-2.36.84-3.603.987a6.293 6.293 0 0 0 2.758-3.47 12.518 12.518 0 0 1-3.983 1.52A6.274 6.274 0 0 0 15.64 6.815c0 .493.056.97.161 1.43a17.811 17.811 0 0 1-12.93-6.555 6.252 6.252 0 0 0-.85 3.154 6.272 6.272 0 0 0 2.791 5.222 6.253 6.253 0 0 1-2.841-.785l-.001.077a6.277 6.277 0 0 0 5.033 6.153 6.305 6.305 0 0 1-2.834.108 6.278 6.278 0 0 0 5.86 4.356 12.59 12.59 0 0 1-7.79 2.686c-.5 0-1-.03-1.497-.088a17.746 17.746 0 0 0 9.616 2.818c11.54 0 17.849-9.559 17.849-17.848 0-.272-.007-.544-.019-.812a12.746 12.746 0 0 0 3.13-3.246Z"></path></svg><svg width="30" height="24" viewBox="0 0 30 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="item_KKoc" cursor="pointer"><path d="M15.366 0c.801.004 2.805.024 4.935.11l.755.032c2.145.102 4.287.275 5.35.571 1.417.398 2.53 1.56 2.907 3.033.6 2.339.675 6.903.684 8.008l.002.229v.032l-.002.229c-.009 1.104-.084 5.669-.684 8.008-.381 1.478-1.495 2.64-2.907 3.032-1.063.297-3.205.47-5.35.571l-.755.033c-2.13.086-4.134.105-4.935.11h-.734c-1.696-.01-8.785-.087-11.04-.714-1.418-.398-2.532-1.56-2.908-3.032-.6-2.34-.675-6.904-.684-8.008v-.49c.01-1.105.084-5.67.684-8.008.382-1.478 1.496-2.64 2.908-3.033C5.847.086 12.936.01 14.632 0h.734Zm-3.367 6.749v10.5l9-5.25-9-5.25Z"></path></svg><svg width="30" height="30" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg" class="item_KKoc" cursor="pointer"><path d="M6.791 18.77a2.959 2.959 0 0 1-2.952 2.952 2.959 2.959 0 0 1-2.951-2.951 2.959 2.959 0 0 1 2.951-2.952h2.952v2.952Zm1.487 0a2.959 2.959 0 0 1 2.952-2.951 2.959 2.959 0 0 1 2.952 2.952v7.39a2.959 2.959 0 0 1-2.952 2.952 2.959 2.959 0 0 1-2.952-2.952v-7.39ZM11.23 6.792A2.959 2.959 0 0 1 8.278 3.84 2.959 2.959 0 0 1 11.23.888a2.959 2.959 0 0 1 2.952 2.951v2.952H11.23Zm0 1.487a2.959 2.959 0 0 1 2.952 2.952 2.959 2.959 0 0 1-2.952 2.952H3.84A2.959 2.959 0 0 1 .887 11.23a2.959 2.959 0 0 1 2.951-2.952h7.391Zm11.98 2.952a2.959 2.959 0 0 1 2.951-2.952 2.959 2.959 0 0 1 2.952 2.952 2.959 2.959 0 0 1-2.952 2.952H23.21V11.23Zm-1.488 0a2.959 2.959 0 0 1-2.951 2.952 2.959 2.959 0 0 1-2.952-2.952V3.84A2.959 2.959 0 0 1 18.771.887a2.959 2.959 0 0 1 2.951 2.951v7.391Zm-2.951 11.98a2.959 2.959 0 0 1 2.951 2.951 2.959 2.959 0 0 1-2.951 2.952 2.959 2.959 0 0 1-2.952-2.952V23.21h2.952Zm0-1.488a2.959 2.959 0 0 1-2.952-2.951 2.959 2.959 0 0 1 2.952-2.952h7.39a2.959 2.959 0 0 1 2.952 2.952 2.959 2.959 0 0 1-2.952 2.951h-7.39Z"></path></svg><svg width="28" height="30" viewBox="0 0 28 30" fill="none" xmlns="http://www.w3.org/2000/svg" class="item_KKoc" cursor="pointer"><path d="M22.48 4.286H5.195c-.845 0-1.52.724-1.52 1.568v18.579c0 .844.675 1.568 1.52 1.568h17.283c.845 0 1.52-.724 1.52-1.568V5.854c0-.844-.675-1.568-1.52-1.568Z"></path><path d="M6.233 12.156h3.081v10.756H6.233V12.156Zm1.57-5.315c.988 0 1.802.875 1.802 1.938s-.814 1.939-1.803 1.939C6.814 10.718 6 9.842 6 8.779c0-1.063.814-1.938 1.802-1.938Zm3.488 5.315h2.965v1.439h.058c.407-.876 1.453-1.751 2.965-1.751 3.14 0 3.721 2.25 3.721 5.127v5.879h-3.081v-5.253c0-1.25 0-2.877-1.628-2.877s-1.86 1.376-1.86 2.752v5.315h-3.082v-10.63h-.058Z" fill="#000"></path></svg><svg width="34" height="28" viewBox="0 0 34 28" fill="none" xmlns="http://www.w3.org/2000/svg" class="item_KKoc" cursor="pointer"><path d="M26.863 16.567c.748 0 1.347-.636 1.347-1.347 0-.748-.599-1.347-1.347-1.347s-1.347.599-1.347 1.347.599 1.347 1.347 1.347Zm-6.639 0c.749 0 1.347-.636 1.347-1.347 0-.748-.598-1.347-1.347-1.347-.748 0-1.346.599-1.346 1.347s.598 1.347 1.346 1.347Zm9.852 7.56a.52.52 0 0 0-.258.553c0 .074 0 .148.036.221.148.627.442 1.622.442 1.66 0 .11.037.184.037.257a.33.33 0 0 1-.331.332c-.074 0-.11-.037-.184-.074l-2.174-1.253c-.147-.074-.331-.147-.516-.147-.11 0-.22 0-.294.037-1.032.294-2.1.442-3.242.442-5.49 0-9.91-3.687-9.91-8.258 0-4.57 4.42-8.257 9.91-8.257 5.489 0 9.91 3.686 9.91 8.257 0 2.47-1.327 4.719-3.427 6.23ZM24.01 8.147a13.662 13.662 0 0 0-.418-.007c-6.262 0-11.41 4.29-11.41 9.757 0 .83.119 1.634.342 2.4h-.133c-1.33 0-2.659-.221-3.877-.553-.111-.037-.222-.037-.333-.037-.221 0-.443.074-.627.185L4.932 21.4a.525.525 0 0 1-.221.074.409.409 0 0 1-.406-.405c0-.11.036-.184.073-.294.037-.037.37-1.251.554-1.987 0-.074.037-.184.037-.258a.834.834 0 0 0-.332-.662C2.089 16.065.5 13.378.5 10.398.501 4.916 5.855.5 12.428.5 18.073.5 22.82 3.753 24.01 8.146Zm-7.73.627c.859 0 1.54-.716 1.54-1.54 0-.858-.681-1.539-1.54-1.539-.86 0-1.54.68-1.54 1.54 0 .859.68 1.54 1.54 1.54Zm-7.89 0c.86 0 1.54-.716 1.54-1.54 0-.858-.68-1.539-1.54-1.539-.859 0-1.539.68-1.539 1.54 0 .859.68 1.54 1.54 1.54Z"></path></svg></div></div></div><div class="copyrightWrap_yPz7"><div class="copyright_AoBa">
      <p>
        Apache Cloudberry is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the Apache Incubator. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.
      </p>
      <p>
        Copyright © 2025 The Apache Software Foundation, Licensed under the Apache License, Version 2.0.</p>
      <p>
        Apache®, the names of Apache projects, and the feather logo are either registered trademarks or trademarks of the Apache Software Foundation in the United States and/or other countries.
      </p>
      </div></div></div></div>
</body>
</html>